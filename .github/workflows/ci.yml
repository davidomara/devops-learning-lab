name: CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  IMAGE_BASE: ghcr.io/${{ github.repository_owner }}/hello-app-hub

jobs:

  # -----------------------------
  # 1. BUILD & ARTIFACT EXPORT
  # -----------------------------
  build:
    name: Build Image
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set Image Tag
        id: vars
        run: echo "${GITHUB_SHA::7}" > image_tag.txt

      - name: Upload tag artifact
        uses: actions/upload-artifact@v4
        with:
          name: image_tag
          path: image_tag.txt
          retention-days: 7

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      - name: Build Docker image
        run: |
          TAG=$(cat image_tag.txt)
          docker build -t $IMAGE_BASE:$TAG .

      - name: Push Docker image
        run: |
          TAG=$(cat image_tag.txt)
          docker push $IMAGE_BASE:$TAG

  # -----------------------------
  # 2. TEST (DOWNLOAD ARTIFACT)
  # -----------------------------
  test:
    name: Test App
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v4

      - name: Download tag artifact
        uses: actions/download-artifact@v4
        with:
          name: image_tag

      - name: Show the tag
        run: |
          TAG=$(cat image_tag.txt)
          echo "TAG from artifact: $TAG"

      - name: Run tests
        run: |
          echo "Running tests..."
          python app/app.py

  # -----------------------------
  # 3. DEPLOY DEV
  # -----------------------------
  deploy_dev:
    name: Deploy DEV
    runs-on: ubuntu-latest
    needs: test
    environment: dev

    steps:
      - name: Download tag artifact
        uses: actions/download-artifact@v4
        with:
          name: image_tag

      - name: Deploy to Dev
        run: |
          TAG=$(cat image_tag.txt)
          echo "Deploying DEV with image tag: $TAG"
          # Example deployment:
          # ssh user@dev "docker pull $IMAGE_BASE:$TAG && docker compose up -d"

  # -----------------------------
  # 4. DEPLOY STAGING (MANUAL)
  # -----------------------------
  deploy_staging:
    name: Deploy STAGING
    runs-on: ubuntu-latest
    needs: deploy_dev
    environment:
      name: staging
      # Enable manual approval in GitHub UI
    steps:
      - name: Download tag artifact
        uses: actions/download-artifact@v4
        with:
          name: image_tag

      - name: Deploy to Staging
        run: |
          TAG=$(cat image_tag.txt)
          echo "Deploying STAGING with image tag: $TAG"

  # -----------------------------
  # 5. DEPLOY PROD (MANUAL)
  # -----------------------------
  deploy_prod:
    name: Deploy PROD
    runs-on: ubuntu-latest
    needs: deploy_staging
    environment: prod

    steps:
      - name: Download tag artifact
        uses: actions/download-artifact@v4
        with:
          name: image_tag

      - name: Deploy to Prod
        run: |
          TAG=$(cat image_tag.txt)
          echo "Deploying PROD with image tag: $TAG"
